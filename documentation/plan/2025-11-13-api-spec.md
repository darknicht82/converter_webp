# Especificación API - WebP ↔ WordPress (2025-11-13)

## Autenticación

- Header obligatorio: `X-API-Token: {token}`
- Respuesta común de error por autenticación:
```json
{
  "success": false,
  "error": "invalid_token",
  "message": "Token inválido o revocado"
}
```

---

## 1. GET `/api.php?action=wp/status`

### Descripción
Retorna información del token y métricas resumidas.

### Headers
- `X-API-Token`

### Respuesta
```json
{
  "success": true,
  "token": {
    "label": "Cliente Demo",
    "status": "active",
    "monthly_quota": 5000,
    "used_this_month": 1200,
    "cost_per_image": 0.05
  },
  "site": {
    "site_id": 3,
    "site_url": "https://ejemplo.com",
    "wp_version": "6.6.1",
    "plugin_version": "1.0.0"
  },
  "metrics": {
    "total_images": 874,
    "total_bytes_saved": 456789012,
    "total_cost": 43.70,
    "last_conversion_at": "2025-11-12T18:32:12Z"
  }
}
```

---

## 2. POST `/api.php?action=wp/register-site`

### Descripción
Registra o actualiza la información del sitio WordPress que usa el token.

### Body JSON
```json
{
  "site_url": "https://ejemplo.com",
  "wp_version": "6.6.1",
  "plugin_version": "1.0.0",
  "locale": "es_ES"
}
```

### Respuesta
```json
{
  "success": true,
  "site_id": 3,
  "message": "Sitio registrado"
}
```

---

## 3. POST `/api.php?action=wp/convert`

### Descripción
Recibe solicitud de conversión de un archivo. Opciones:
- Enviar URL para que el servicio descargue.
- Adjuntar archivo base64 si se prefiere.

### Body JSON (modo URL)
```json
{
  "attachment_id": 123,
  "file_url": "https://ejemplo.com/wp-content/uploads/2025/01/foto.jpg",
  "file_path": "2025/01/foto.jpg",
  "original_bytes": 452367,
  "options": {
    "quality": 85,
    "preserve_metadata": true
  }
}
```

### Respuesta exitosa
```json
{
  "success": true,
  "converted_bytes": 98765,
  "bytes_saved": 353602,
  "cost": 0.05,
  "download_url": "https://webp-core.local/temp/uuid.webp",
  "batch_id": "54c1b8c2-0c6a-4f3e-9f7a-1138d5f2e543",
  "logs": [
    "Archivo descargado",
    "Conversión WebP completada"
  ]
}
```

### Respuesta error
```json
{
  "success": false,
  "error": "conversion_failed",
  "message": "No se pudo optimizar la imagen",
  "logs": [
    "Timeout al descargar archivo"
  ]
}
```

---

## 4. POST `/api.php?action=wp/report`

### Descripción
El plugin envía resumen de conversiones realizadas (para sincronización o reintentos).

### Body JSON
```json
{
  "batch_id": "54c1b8c2-0c6a-4f3e-9f7a-1138d5f2e543",
  "site_id": 3,
  "results": [
    {
      "attachment_id": 123,
      "status": "success",
      "original_bytes": 452367,
      "converted_bytes": 98765,
      "cost": 0.05,
      "processed_at": "2025-11-12T18:32:12Z"
    },
    {
      "attachment_id": 124,
      "status": "failed",
      "message": "Archivo no encontrado"
    }
  ]
}
```

### Respuesta
```json
{
  "success": true,
  "processed": 2,
  "stored": 2,
  "message": "Reporte registrado"
}
```

---

## 5. GET `/api.php?action=wp/download-plugin`

### Descripción
Entrega el ZIP del plugin. Requiere token.

### Respuesta (cabeceras)
- `Content-Type: application/zip`
- `Content-Disposition: attachment; filename="webp-converter-wordpress-1.0.0.zip"`

Body: archivo binario.

---

## Respuestas estándar

```json
{
  "success": false,
  "error": "rate_limit",
  "message": "Has excedido el límite de 100 conversiones por minuto"
}
```

```json
{
  "success": false,
  "error": "invalid_payload",
  "message": "Campo attachment_id es obligatorio"
}
```

---

Esta especificación cubre el MVP. Nuevos endpoints (p.ej. revocar tokens, métricas detalladas) se documentarán conforme avance el desarrollo.

